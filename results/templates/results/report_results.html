{% extends 'base.html' %}
{% block title %}Results Report{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="card shadow">
        <div class="card-header bg-success text-white">
            <h2 class="mb-0">üìà Results Report & Analytics</h2>
            <p class="mb-0 opacity-75">Comprehensive analysis of student performance</p>
        </div>
        <div class="card-body">
            <!-- Statistics Overview -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3 class="display-4">{{ total_students }}</h3>
                            <p class="mb-0">Total Students</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h3 class="display-4">{{ total_subjects }}</h3>
                            <p class="mb-0">Total Subjects</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h3 class="display-4">{{ total_results }}</h3>
                            <p class="mb-0">Total Results</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3 class="display-4">{{ published_results }}</h3>
                            <p class="mb-0">Published Results</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- Grade Distribution -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">üìä Grade Distribution</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="gradeChart" width="400" height="200"></canvas>
                            <div class="mt-3">
                                {% for grade in grade_distribution %}
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="badge badge-{{ grade.color }} mr-2">{{ grade.name }}</span>
                                    <span>{{ grade.count }} students ({{ grade.percentage }}%)</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Subject Performance -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">üìö Subject Performance Overview</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="subjectChart" width="400" height="200"></canvas>
                            <div class="table-responsive mt-3">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Subject</th>
                                            <th>Avg Score</th>
                                            <th>Pass Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for subject in subject_performance %}
                                        <tr>
                                            <td>{{ subject.name }}</td>
                                            <td>{{ subject.avg_score }}%</td>
                                            <td>
                                                <span class="badge badge-{% if subject.pass_rate >= 80 %}success{% elif subject.pass_rate >= 60 %}warning{% else %}danger{% endif %}">
                                                    {{ subject.pass_rate }}%
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- Top Performers -->
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">üèÜ Top Performers</h5>
                        </div>
                        <div class="card-body">
                            {% for student in top_performers %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <strong>{{ student.name }}</strong>
                                    <small class="text-muted d-block">{{ student.class }}</small>
                                </div>
                                <span class="badge badge-success">{{ student.average }}%</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Performance Trends -->
                <div class="col-md-8 mb-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">üìà Performance Trends</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="trendChart" width="800" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- Detailed Results Table -->
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">üìã Detailed Results</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportToExcel()">
                                    üìä Export to Excel
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="printReport()">
                                    üñ®Ô∏è Print Report
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filter Controls -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <select class="form-control" id="classFilter">
                                        <option value="">All Classes</option>
                                        {% for class in classes %}
                                        <option value="{{ class.id }}">{{ class.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" id="subjectFilter">
                                        <option value="">All Subjects</option>
                                        {% for subject in subjects %}
                                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" id="statusFilter">
                                        <option value="">All Status</option>
                                        <option value="published">Published</option>
                                        <option value="draft">Draft</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="searchInput" placeholder="Search students...">
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="resultsTable">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Student ID</th>
                                            <th>Name</th>
                                            <th>Class</th>
                                            <th>Subject</th>
                                            <th>Score</th>
                                            <th>Grade</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for result in results %}
                                        <tr>
                                            <td>{{ result.student.student_id }}</td>
                                            <td>{{ result.student.name }}</td>
                                            <td>{{ result.student.class }}</td>
                                            <td>{{ result.subject.name }}</td>
                                            <td>
                                                <span class="badge badge-{% if result.score >= 80 %}success{% elif result.score >= 60 %}warning{% else %}danger{% endif %}">
                                                    {{ result.score }}%
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge badge-{% if result.grade == 'A' %}success{% elif result.grade == 'B' %}info{% elif result.grade == 'C' %}warning{% else %}danger{% endif %}">
                                                    {{ result.grade }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge badge-{% if result.is_published %}success{% else %}secondary{% endif %}">
                                                    {% if result.is_published %}Published{% else %}Draft{% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{% url 'edit_result' result.id %}" class="btn btn-outline-primary btn-sm">Edit</a>
                                                    <a href="{% url 'view_result' result.id %}" class="btn btn-outline-info btn-sm">View</a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav aria-label="Results pagination">
                                <ul class="pagination justify-content-center">
                                    {% if results.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ results.previous_page_number }}">Previous</a>
                                    </li>
                                    {% endif %}
                                    
                                    {% for num in results.paginator.page_range %}
                                    <li class="page-item {% if num == results.number %}active{% endif %}">
                                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                    </li>
                                    {% endfor %}
                                    
                                    {% if results.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ results.next_page_number }}">Next</a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Summary Statistics -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">üìä Summary Statistics</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-2 text-center mb-3">
                                    <h4 class="text-primary">{{ overall_average }}%</h4>
                                    <small class="text-muted">Overall Average</small>
                                </div>
                                <div class="col-md-2 text-center mb-3">
                                    <h4 class="text-success">{{ pass_rate }}%</h4>
                                    <small class="text-muted">Pass Rate</small>
                                </div>
                                <div class="col-md-2 text-center mb-3">
                                    <h4 class="text-info">{{ highest_score }}%</h4>
                                    <small class="text-muted">Highest Score</small>
                                </div>
                                <div class="col-md-2 text-center mb-3">
                                    <h4 class="text-warning">{{ lowest_score }}%</h4>
                                    <small class="text-muted">Lowest Score</small>
                                </div>
                                <div class="col-md-2 text-center mb-3">
                                    <h4 class="text-secondary">{{ median_score }}%</h4>
                                    <small class="text-muted">Median Score</small>
                                </div>
                                <div class="col-md-2 text-center mb-3">
                                    <h4 class="text-dark">{{ std_deviation }}%</h4>
                                    <small class="text-muted">Std Deviation</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- <script> -->
// Grade Distribution Chart
const gradeCtx = document.getElementById('gradeChart').getContext('2d');
new Chart(gradeCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for grade in grade_distribution %}"{{ grade.name|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for grade in grade_distribution %}{{ grade.count|default:"0" }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6f42c1']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Subject Performance Chart
const subjectCtx = document.getElementById('subjectChart').getContext('2d');
new Chart(subjectCtx, {
    type: 'bar',
    data: {
        labels: [{% for subject in subject_performance %}'{{ subject.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Average Score',
            data: [{% for subject in subject_performance %}{{ subject.avg_score }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: '#007bff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});

// Trend Chart
const trendCtx = document.getElementById('trendChart').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: [{% for trend in performance_trends %}'{{ trend.period }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Average Performance',
            data: [{% for trend in performance_trends %}{{ trend.average }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});

// Filter functionality
document.getElementById('classFilter').addEventListener('change', filterResults);
document.getElementById('subjectFilter').addEventListener('change', filterResults);
document.getElementById('statusFilter').addEventListener('change', filterResults);
document.getElementById('searchInput').addEventListener('input', filterResults);

function filterResults() {
    // Implementation for filtering results table
    const classFilter = document.getElementById('classFilter').value;
    const subjectFilter = document.getElementById('subjectFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    const rows = document.querySelectorAll('#resultsTable tbody tr');
    
    rows.forEach(row => {
        let showRow = true;
        const cells = row.querySelectorAll('td');
        
        // Apply filters
        if (classFilter && !cells[2].textContent.includes(classFilter)) showRow = false;
        if (subjectFilter && !cells[3].textContent.includes(subjectFilter)) showRow = false;
        if (statusFilter && !cells[6].textContent.toLowerCase().includes(statusFilter)) showRow = false;
        if (searchTerm && !cells[1].textContent.toLowerCase().includes(searchTerm)) showRow = false;
        
        row.style.display = showRow ? '' : 'none';
    });
}

function exportToExcel() {
    // Implementation for Excel export
    alert('Excel export functionality would be implemented here');
}

function printReport() {
    window.print();
}
<!-- </script> -->
{% endblock